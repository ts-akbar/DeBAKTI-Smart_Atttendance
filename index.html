<!doctype html>
<html lang="ms" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeBakti Smart Attendance Cloud</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
        html, body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
        }
        
        #app {
            min-height: 100%;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body * { 
                visibility: hidden; 
            }
            #print-area, #print-area * { 
                visibility: visible; 
            }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                background: white !important;
                padding: 20px;
            }
            #print-area table {
                page-break-inside: auto;
            }
            #print-area tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .no-print { 
                display: none !important; 
            }
            .print-button {
                display: none !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto"></div>
  <script>
        // --- SDK MOCK UNTUK SIMPANAN SPREADSHEET & LOCAL ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCvJDS5NdSMDZriLW31pgLntJyGUQsAVu950AtfQrvDeKKEVPijMYmvNjcGbWVE7c/exec';

        window.dataSdk = {
            async init(handler) {
                const data = JSON.parse(localStorage.getItem('debakti_data') || '[]');
                handler.onDataChanged(data);
                
                try {
                    // Penambahan timestamp (?t=...) memastikan pelayar sentiasa menarik data terkini dari Spreadsheet
                    const response = await fetch(SCRIPT_URL + "?action=read&t=" + new Date().getTime());
                    if (response.ok) {
                        const sheetData = await response.json();
                        if (Array.isArray(sheetData)) {
                            localStorage.setItem('debakti_data', JSON.stringify(sheetData));
                            handler.onDataChanged(sheetData);
                        }
                    }
                } catch (e) {
                    console.log('Using local storage as primary DB.', e);
                }
                return { isOk: true };
            },
            async create(record) {
                record.__backendId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                const data = JSON.parse(localStorage.getItem('debakti_data') || '[]');
                data.push(record);
                localStorage.setItem('debakti_data', JSON.stringify(data));
                
                // Hantar data ke Google Spreadsheet
                try {
                    const formData = new FormData();
                    formData.append('method', 'create');
                    formData.append('backendId', record.__backendId);
                    formData.append('type', record.type);
                    formData.append('nama', record.name || '-');
                    formData.append('ic', record.ic || '-');
                    
                    if (record.type === 'attendance') {
                        formData.append('tarikh', record.date || '-');
                        
                        if (record.action === 'masuk') {
                            formData.append('masa_masuk', record.time || '-');
                            formData.append('masa_keluar', '-');
                        } else if (record.action === 'keluar') {
                            formData.append('masa_masuk', '-');
                            formData.append('masa_keluar', record.time || '-');
                        } else {
                            formData.append('masa_masuk', '-');
                            formData.append('masa_keluar', '-');
                        }
                        
                        formData.append('tindakan', record.action || '-');
                        formData.append('catatan', record.note || '-');
                    } else if (record.type === 'user') {
                        formData.append('jawatan', record.role || '-');
                        formData.append('syif', record.shift || '-');
                        formData.append('tarikh', '-');
                        formData.append('masa_masuk', '-');
                        formData.append('masa_keluar', '-');
                        formData.append('tindakan', '-');
                        formData.append('catatan', '-');
                    }

                    // Sisipkan raw record string untuk keupayaan memanggil data (sinkronisasi)
                    formData.append('rawData', JSON.stringify(record));

                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: formData
                    });
                } catch (e) {
                    console.error("Gagal hantar ke spreadsheet", e);
                }

                if (state.initialized) dataHandler.onDataChanged(data);
                return { isOk: true };
            },
            async update(record) {
                const data = JSON.parse(localStorage.getItem('debakti_data') || '[]');
                const index = data.findIndex(r => r.__backendId === record.__backendId);
                if (index !== -1) {
                    data[index] = record;
                    localStorage.setItem('debakti_data', JSON.stringify(data));
                    
                    try {
                        const formData = new FormData();
                        formData.append('method', 'update');
                        formData.append('backendId', record.__backendId);
                        formData.append('type', record.type);
                        formData.append('nama', record.name || '-');
                        formData.append('ic', record.ic || '-');
                        
                        if (record.type === 'attendance') {
                            formData.append('tarikh', record.date || '-');
                            formData.append('masa_masuk', record.action === 'masuk' ? record.time : '-');
                            formData.append('masa_keluar', record.action === 'keluar' ? record.time : '-');
                            formData.append('tindakan', record.action || '-');
                            formData.append('catatan', record.note || '-');
                        } else if (record.type === 'user') {
                            formData.append('jawatan', record.role || '-');
                            formData.append('syif', record.shift || '-');
                            formData.append('tarikh', '-');
                            formData.append('masa_masuk', '-');
                            formData.append('masa_keluar', '-');
                            formData.append('tindakan', '-');
                            formData.append('catatan', '-');
                        }

                        formData.append('rawData', JSON.stringify(record));

                        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData });
                    } catch (e) {}

                    if (state.initialized) dataHandler.onDataChanged(data);
                    return { isOk: true };
                }
                return { isOk: false };
            },
            async delete(record) {
                let data = JSON.parse(localStorage.getItem('debakti_data') || '[]');
                data = data.filter(r => r.__backendId !== record.__backendId);
                localStorage.setItem('debakti_data', JSON.stringify(data));
                
                try {
                    const formData = new FormData();
                    formData.append('method', 'delete');
                    formData.append('backendId', record.__backendId);
                    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData });
                } catch (e) {}

                if (state.initialized) dataHandler.onDataChanged(data);
                return { isOk: true };
            }
        };

        window.elementSdk = {
            config: JSON.parse(localStorage.getItem('debakti_config')) || null,
            async init(options) {
                this.options = options;
                if (!this.config) this.config = options.defaultConfig || {};
                if (options.onConfigChange) options.onConfigChange(this.config);
                return { isOk: true };
            },
            async setConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                localStorage.setItem('debakti_config', JSON.stringify(this.config));
                if (this.options && this.options.onConfigChange) this.options.onConfigChange(this.config);
                return { isOk: true };
            }
        };
        // --- TAMAT SDK MOCK ---

        const defaultConfig = {
            app_title: "DeBAKTI SMART Attendance",
            welcome_message: "Selamat datang ke sistem kehadiran pintar",
            login_button_text: "Log Masuk",
            register_button_text: "Daftar Pengguna Baru",
            clock_in_text: "Daftar Masuk",
            clock_out_text: "Daftar Keluar",
            background_color: "#f0f9ff",
            surface_color: "#ffffff",
            text_color: "#1e293b",
            primary_action_color: "#3b82f6",
            secondary_action_color: "#64748b",
            font_family: "Inter",
            font_size: 16
        };

        const MONTHS = ["JANUARI", "FEBRUARI", "MAC", "APRIL", "MEI", "JUN", "JULAI", "OGOS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DISEMBER"];
        const SHIFTS = ["7.30 - 4.30", "8.00 - 5.00", "9.00 - 6.00", "Fleksibel"];

        let state = {
            users: [],
            attendance: [],
            view: 'login',
            currentUser: null,
            selectedMonth: new Date().getMonth(),
            selectedYear: new Date().getFullYear(),
            selectedStaffIc: null,
            loading: false,
            recordCount: 0,
            showPunchModal: false,
            punchModalAction: null,
            deleteModal: null,
            editUserModal: null,
            editPunchModal: null,
            regRole: null,
            regName: '',
            regIc: '',
            regShift: '7.30 - 4.30',
            adminTab: 'daily',
            initialized: false,
            selectedNoteStatus: 'hadir'
        };

        const dataHandler = {
            onDataChanged(data) {
                state.users = data.filter(r => r.type === 'user');
                state.attendance = data.filter(r => r.type === 'attendance');
                state.recordCount = data.length;
                render();
            }
        };

        function notify(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function registerUser(name, ic, role, shift) {
            const existing = state.users.find(u => u.ic === ic);
            if (existing) {
                notify("No. IC sudah wujud!", "error");
                return;
            }

            state.loading = true;
            render();

            const result = await window.dataSdk.create({
                type: 'user',
                name: name,
                ic: ic,
                role: role,
                shift: shift,
                card_color: 'yellow',
                timestamp: Date.now()
            });

            state.loading = false;

            if (result.isOk) {
                notify("Pendaftaran berjaya!", "success");
                state.view = 'login';
                state.regRole = null;
                render();
            } else {
                notify("Ralat pendaftaran!", "error");
                render();
            }
        }

        async function recordAttendance(action, note = '') {
            state.loading = true;
            render();

            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const dateStr = `${day}/${month}/${year}`;
            
            const result = await window.dataSdk.create({
                type: 'attendance',
                name: state.currentUser.name,
                ic: state.currentUser.ic,
                role: state.currentUser.role,
                shift: state.currentUser.shift,
                date: dateStr,
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                action: action,
                note: note,
                timestamp: Date.now()
            });

            state.loading = false;

            if (result.isOk) {
                notify(`${action === 'masuk' ? 'Daftar masuk' : 'Daftar keluar'} berjaya!`, "success");
                render();
            } else {
                notify("Ralat merekod kehadiran!", "error");
                render();
            }
        }

        async function deleteUser(user) {
            state.loading = true;
            render();

            // Padam pengguna
            const deleteUserResult = await window.dataSdk.delete(user);

            if (!deleteUserResult.isOk) {
                state.loading = false;
                notify("Ralat memadam pengguna!", "error");
                render();
                return;
            }

            // Padam SEMUA rekod kehadiran pengguna ini
            const userAttendance = state.attendance.filter(r => r.ic === user.ic);
            
            for (const record of userAttendance) {
                await window.dataSdk.delete(record);
            }

            state.loading = false;
            notify(`Pengguna dan ${userAttendance.length} rekod kehadiran dipadam!`, "success");
            render();
        }

        async function deleteAttendance(record) {
            state.loading = true;
            render();

            const result = await window.dataSdk.delete(record);

            state.loading = false;

            if (result.isOk) {
                notify("Rekod kehadiran dipadam!", "success");
                render();
            } else {
                notify("Ralat memadam rekod!", "error");
                render();
            }
        }

        async function updateUser(user, newName, newIc) {
            state.loading = true;
            render();

            user.name = newName;
            user.ic = newIc;

            const result = await window.dataSdk.update(user);

            state.loading = false;

            if (result.isOk) {
                notify("Maklumat pengguna dikemaskini!", "success");
                render();
            } else {
                notify("Ralat mengemaskini pengguna!", "error");
                render();
            }
        }

        async function updateUserCardColor(user, color) {
            state.loading = true;
            render();

            user.card_color = color;

            const result = await window.dataSdk.update(user);

            state.loading = false;

            if (result.isOk) {
                notify(`Warna kad dikemaskini kepada ${color === 'green' ? 'hijau' : color === 'yellow' ? 'kuning' : 'merah'}!`, "success");
                render();
            } else {
                notify("Ralat mengemaskini warna kad!", "error");
                render();
            }
        }

        window.editPunchRecord = (recordId, action) => {
            const record = state.attendance.find(r => r.__backendId === recordId);
            if (!record) return;
            
            state.editPunchModal = {
                recordId: recordId,
                action: action,
                currentTime: record.time,
                currentDate: record.date
            };
            render();
        };

        window.closeEditPunchModal = () => {
            state.editPunchModal = null;
            render();
        };

        window.submitEditPunchRecord = async (e) => {
            e.preventDefault();
            
            const newDate = document.getElementById('edit-punch-date').value.trim();
            const newTime = document.getElementById('edit-punch-time').value.trim();
            
            if (!newDate || !newTime) {
                notify('Sila isi semua medan!', 'error');
                return;
            }
            
            // Validasi format tarikh DD/MM/YYYY
            const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!dateRegex.test(newDate)) {
                notify('Format tarikh tidak sah. Gunakan DD/MM/YYYY!', 'error');
                return;
            }
            
            // Validasi format masa HH:MM
            const timeRegex = /^\d{2}:\d{2}$/;
            if (!timeRegex.test(newTime)) {
                notify('Format masa tidak sah. Gunakan HH:MM!', 'error');
                return;
            }
            
            if (!state.editPunchModal) return;
            
            const record = state.attendance.find(r => r.__backendId === state.editPunchModal.recordId);
            if (!record) return;
            
            state.loading = true;
            render();
            
            record.date = newDate;
            record.time = newTime;
            
            const result = await window.dataSdk.update(record);
            
            state.loading = false;
            
            if (result.isOk) {
                notify('Rekod punch berjaya dikemaskini!', 'success');
                state.editPunchModal = null;
                render();
            } else {
                notify('Ralat mengemaskini rekod punch!', 'error');
                render();
            }
        };

        window.promptDeleteUser = (user) => {
            showDeleteModal('user', user.__backendId);
        };

        window.printDailyReport = () => {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const today = `${day}/${month}/${year}`;
            
            const staff = state.users.filter(u => u.role === 'guru' || u.role === 'akp' || u.role === 'guru besar');
            const totalStaff = staff.length;
            // Kira 'masuk' dan 'bersebab' sebagai hadir, KECUALI jika catatan mengandungi "CUTI BERSALIN". Cuti (th) TIDAK dikira sebagai hadir
            const todayAttendance = state.attendance.filter(r => {
                const user = state.users.find(u => u.ic === r.ic);
                if (!user || !(user.role === 'guru' || user.role === 'akp' || user.role === 'guru besar')) return false;
                if (r.date !== today) return false;
                
                if (r.action === 'masuk') return true;
                if (r.action === 'bersebab') {
                    const noteContent = (r.note || '').toUpperCase();
                    return !noteContent.includes('CUTI BERSALIN');
                }
                return false;
            });
            const uniqueStaffToday = new Set(todayAttendance.map(r => r.ic)).size;
            const attendancePercentage = totalStaff > 0 ? Math.round((uniqueStaffToday / totalStaff) * 100) : 0;
            
            const config = window.elementSdk?.config || defaultConfig;
            const baseSize = config.font_size || defaultConfig.font_size;
            
            let tableRows = '';
            staff.sort((a,b) => a.name.localeCompare(b.name)).forEach(u => {
                const dayRecords = state.attendance.filter(a => a.ic === u.ic && a.date === today);
                const clockIn = dayRecords.find(r => r.action === 'masuk');
                const clockOut = dayRecords.find(r => r.action === 'keluar');
                const thRecord = dayRecords.find(r => r.action === 'th');
                const bersebabRecord = dayRecords.find(r => r.action === 'bersebab');
                
                let status = '';
                let note = '';
                if (thRecord) {
                    status = 'TIDAK HADIR';
                    note = thRecord.note || '';
                } else if (bersebabRecord) {
                    status = 'HADIR';
                    note = bersebabRecord.note || '';
                } else if (clockIn) {
                    status = 'HADIR';
                    note = clockIn.note || clockOut?.note || '';
                } else {
                    status = 'TIDAK HADIR';
                }
                
                const time = clockIn ? (clockOut ? `${clockIn.time} - ${clockOut.time}` : clockIn.time) : '--:--';
                
                tableRows += `
                    <tr>
                        <td>
                            <strong>${u.name.toUpperCase()}</strong><br>
                            <small style="color: #64748b;">${u.ic} ‚Ä¢ ${u.role.toUpperCase()}</small>
                        </td>
                        <td style="text-align: center;">${time}</td>
                        <td style="text-align: center;">${status}</td>
                        <td style="text-align: left; font-style: ${note ? 'italic' : 'normal'};">
                            ${note || '-'}
                        </td>
                    </tr>
                `;
            });
            
            const printWindow = window.open('', '_blank', 'width=1024,height=768');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Harian - ${today}</title>
                    <style>
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            margin: 30px;
                            background: white;
                            color: #1e293b;
                            font-size: ${baseSize}px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #3b82f6;
                        }
                        .header h1 {
                            font-size: ${baseSize * 1.8}px;
                            font-weight: 800;
                            margin: 0 0 10px 0;
                            text-transform: uppercase;
                        }
                        .header .date {
                            font-size: ${baseSize * 1.1}px;
                            color: #64748b;
                            font-weight: 600;
                        }
                        .stats {
                            display: flex;
                            justify-content: center;
                            gap: 30px;
                            margin: 20px 0 30px 0;
                            padding: 20px;
                            background: #f8fafc;
                            border-radius: 12px;
                        }
                        .stat-box {
                            text-align: center;
                        }
                        .stat-label {
                            font-size: ${baseSize * 0.75}px;
                            color: #64748b;
                            font-weight: 700;
                            text-transform: uppercase;
                            margin-bottom: 8px;
                        }
                        .stat-value {
                            font-size: ${baseSize * 2}px;
                            font-weight: 800;
                            color: #1e293b;
                        }
                        .stat-value.highlight {
                            color: #3b82f6;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid #e2e8f0;
                            padding: 12px;
                            text-align: left;
                        }
                        th {
                            background: #f8fafc;
                            font-weight: 700;
                            font-size: ${baseSize * 0.85}px;
                            text-transform: uppercase;
                            color: #64748b;
                        }
                        td {
                            font-size: ${baseSize * 0.9}px;
                        }
                        tr:hover {
                            background: #f8fafc;
                        }
                        @media print {
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                            body {
                                margin: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LAPORAN KEHADIRAN HARIAN</h1>
                        <div class="date">${today}</div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-label">Jumlah Kakitangan</div>
                            <div class="stat-value">${totalStaff}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Hadir Hari Ini</div>
                            <div class="stat-value" style="color: #10b981;">${uniqueStaffToday}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Peratus Kehadiran</div>
                            <div class="stat-value highlight">${attendancePercentage}%</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>STAF</th>
                                <th style="text-align: center;">MASA</th>
                                <th style="text-align: center;">STATUS</th>
                                <th style="text-align: left;">CATATAN</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="print-button" style="margin-top: 30px; text-align: center; display: flex; gap: 16px; justify-content: center;">
                        <button onclick="window.print()" style="padding: 12px 32px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                            üñ®Ô∏è CETAK
                        </button>
                        <button onclick="window.close()" style="padding: 12px 32px; background: #64748b; color: white; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                            ‚úñ TUTUP
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        window.printPDF = () => {
            const selectedStaff = state.users.find(u => u.ic === state.selectedStaffIc);
            if (!selectedStaff) return;

            const config = window.elementSdk?.config || defaultConfig;
            const baseSize = config.font_size || defaultConfig.font_size;
            
            const monthRecords = state.attendance.filter(r => {
                if (r.ic !== state.selectedStaffIc) return false;
                
                // Parse DD/MM/YYYY format
                const parts = r.date.split('/');
                if (parts.length !== 3) return false;
                
                const recordDay = parseInt(parts[0], 10);
                const recordMonth = parseInt(parts[1], 10) - 1;
                const recordYear = parseInt(parts[2], 10);
                
                return recordMonth === state.selectedMonth && recordYear === state.selectedYear;
            }).sort((a, b) => {
                const partsA = a.date.split('/');
                const partsB = b.date.split('/');
                const dateA = new Date(parseInt(partsA[2]), parseInt(partsA[1]) - 1, parseInt(partsA[0]));
                const dateB = new Date(parseInt(partsB[2]), parseInt(partsB[1]) - 1, parseInt(partsB[0]));
                return dateA - dateB;
            });

            const daysInMonth = new Date(state.selectedYear, state.selectedMonth + 1, 0).getDate();
            const dailyRecords = {};
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const monthStr = String(state.selectedMonth + 1).padStart(2, '0');
                const dateStr = `${dayStr}/${monthStr}/${state.selectedYear}`;
                
                const dayRecords = monthRecords.filter(r => r.date === dateStr);
                const clockIn = dayRecords.find(r => r.action === 'masuk');
                const clockOut = dayRecords.find(r => r.action === 'keluar');
                const thRecord = dayRecords.find(r => r.action === 'th');
                const bersebabRecord = dayRecords.find(r => r.action === 'bersebab');
                
                const testDate = new Date(state.selectedYear, state.selectedMonth, day);
                const dayOfWeek = testDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let status = '-';
                let note = '';
                
                if (isWeekend) {
                    status = 'C';
                    note = 'Cuti Hujung Minggu';
                } else if (thRecord) {
                    status = 'Tidak Hadir';
                    note = thRecord.note || '';
                } else if (bersebabRecord) {
                    status = 'Hadir';
                    note = bersebabRecord.note || '';
                } else if (clockIn) {
                    status = clockOut ? 'Hadir' : 'Masuk sahaja';
                    note = clockIn.note || clockOut?.note || '';
                }
                
                dailyRecords[day] = {
                    date: dateStr,
                    clockIn: clockIn ? clockIn.time : '-',
                    clockOut: clockOut ? clockOut.time : '-',
                    status: status,
                    note: note
                };
            }

            const totalDays = daysInMonth;
            const weekendDays = Object.values(dailyRecords).filter(r => r.status === 'C').length;
            const workingDays = totalDays - weekendDays;
            // Kira 'Hadir' sebagai hadir (termasuk bersebab yang ditukar ke Hadir). Cuti TIDAK dikira sebagai hadir
            const attendedDays = Object.values(dailyRecords).filter(r => r.status === 'Hadir').length;
            const attendancePercentage = workingDays > 0 ? Math.round((attendedDays / workingDays) * 100) : 0;

            let tableRows = '';
            Object.keys(dailyRecords).forEach(day => {
                const record = dailyRecords[day];
                tableRows += `
                    <tr>
                        <td style="text-align: center; font-weight: 600;">${day}</td>
                        <td>${record.date}</td>
                        <td style="text-align: center;">${record.clockIn}</td>
                        <td style="text-align: center;">${record.clockOut}</td>
                        <td style="text-align: center;">
                            <span style="display: inline-block; padding: 4px 10px; background: ${record.status === 'Hadir' ? '#dcfce7' : record.status === 'Masuk sahaja' ? '#fef3c7' : record.status === 'C' ? '#dbeafe' : record.status === 'TH' ? '#fecaca' : record.status === 'Bersebab' ? '#fed7aa' : '#f3f4f6'}; color: ${record.status === 'Hadir' ? '#166534' : record.status === 'Masuk sahaja' ? '#92400e' : record.status === 'C' ? '#1e40af' : record.status === 'TH' ? '#7f1d1d' : record.status === 'Bersebab' ? '#9a3412' : '#6b7280'}; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-weight: 600;">
                                ${record.status}
                            </span>
                            ${record.note ? `<br><small style="color: #64748b; font-style: italic;">${record.note}</small>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            const printWindow = window.open('', '_blank', 'width=1024,height=768');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Bulanan - ${selectedStaff.name}</title>
                    <style>
                        body {
                            font-family: 'Inter', Arial, sans-serif;
                            margin: 30px;
                            background: white;
                            color: #1e293b;
                            font-size: ${baseSize}px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            font-size: ${baseSize * 1.5}px;
                            font-weight: 800;
                            margin: 0 0 10px 0;
                        }
                        .header .staff-name {
                            font-size: ${baseSize}px;
                            color: #64748b;
                            margin-bottom: 4px;
                            text-transform: uppercase;
                            font-weight: 700;
                        }
                        .header .period {
                            font-size: ${baseSize * 0.9}px;
                            color: #64748b;
                            margin-bottom: 20px;
                        }
                        .stats-box {
                            display: inline-block;
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                            border-radius: 12px;
                            border: 2px solid #3b82f6;
                            margin-bottom: 30px;
                        }
                        .stats-label {
                            font-size: ${baseSize * 0.7}px;
                            color: #1e40af;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 0.05em;
                            margin-bottom: 4px;
                        }
                        .stats-value {
                            font-size: ${baseSize * 1.8}px;
                            font-weight: 800;
                            color: #1e40af;
                        }
                        .stats-details {
                            font-size: ${baseSize * 0.65}px;
                            color: #1e40af;
                            font-weight: 600;
                            margin-top: 4px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            border: 1px solid #e2e8f0;
                            padding: 10px 12px;
                            text-align: left;
                        }
                        th {
                            background: #f8fafc;
                            font-weight: 700;
                            font-size: ${baseSize * 0.85}px;
                            color: #64748b;
                        }
                        td {
                            font-size: ${baseSize * 0.9}px;
                        }
                        @media print {
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                            body {
                                margin: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LAPORAN KEHADIRAN BULANAN</h1>
                        <div class="staff-name">${selectedStaff.name.toUpperCase()} (${selectedStaff.ic})</div>
                        <div class="period">${MONTHS[state.selectedMonth]} ${state.selectedYear}</div>
                        <div class="stats-box">
                            <div class="stats-label">Peratus Kehadiran Bulanan</div>
                            <div class="stats-value">${attendancePercentage}%</div>
                            <div class="stats-details">${attendedDays} hadir daripada ${workingDays} hari bekerja</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: center; width: 60px;">HARI</th>
                                <th>TARIKH</th>
                                <th style="text-align: center;">MASUK</th>
                                <th style="text-align: center;">KELUAR</th>
                                <th style="text-align: center;">STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="print-button" style="margin-top: 30px; text-align: center; display: flex; gap: 16px; justify-content: center;">
                        <button onclick="window.print()" style="padding: 12px 32px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                            üñ®Ô∏è CETAK
                        </button>
                        <button onclick="window.close()" style="padding: 12px 32px; background: #64748b; color: white; border: none; border-radius: 8px; font-size: ${baseSize}px; font-weight: 700; cursor: pointer; text-transform: uppercase;">
                            ‚úñ TUTUP
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            const config = window.elementSdk?.config || defaultConfig;

            const customFont = config.font_family || defaultConfig.font_family;
            const baseSize = config.font_size || defaultConfig.font_size;
            const bgColor = config.background_color || defaultConfig.background_color;
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
            const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;

            document.body.style.fontFamily = `${customFont}, sans-serif`;
            document.body.style.backgroundColor = bgColor;
            document.body.style.color = textColor;

            let content = '';

            if (state.view === 'login') {
                content = renderLogin(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            } else if (state.view === 'register') {
                content = renderRegister(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            } else if (state.view === 'dashboard') {
                content = renderDashboard(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            } else if (state.view === 'admin') {
                content = renderAdmin(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            } else if (state.view === 'report') {
                content = renderReport(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            }

            app.innerHTML = content;
            
            if (state.showPunchModal) {
                app.innerHTML += renderPunchModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            }
            
            if (state.editPunchModal) {
                app.innerHTML += renderEditPunchModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            }
            
            if (state.deleteModal) {
                app.innerHTML += renderDeleteModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            }

            if (state.editUserModal) {
                app.innerHTML += renderEditUserModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            }

            if (state.showNoteModal) {
                app.innerHTML += renderNoteModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor);
            }
        }

        function renderEditPunchModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            if (!state.editPunchModal) return '';
            
            const { recordId, action, currentTime, currentDate } = state.editPunchModal;
            const record = state.attendance.find(r => r.__backendId === recordId);
            if (!record) return '';
            
            return `
                <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px);">
                    <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 24px; padding: 32px; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 2px solid ${primaryColor};">
                        <div style="font-size: ${baseSize * 1.4}px; font-weight: 800; text-align: center; color: ${textColor}; text-transform: uppercase; margin-bottom: 24px;">
                            Edit ${action === 'in' ? 'Punch In' : 'Punch Out'}
                        </div>
                        
                        <form onsubmit="submitEditPunchRecord(event)">
                            <div style="margin-bottom: 20px;">
                                <label for="edit-punch-date" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Tarikh (DD/MM/YYYY)
                                </label>
                                <input 
                                    type="text" 
                                    id="edit-punch-date" 
                                    required 
                                    placeholder="DD/MM/YYYY"
                                    value="${currentDate}"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; box-sizing: border-box;"
                                />
                            </div>

                            <div style="margin-bottom: 24px;">
                                <label for="edit-punch-time" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Masa (HH:MM)
                                </label>
                                <input 
                                    type="text" 
                                    id="edit-punch-time" 
                                    required 
                                    placeholder="HH:MM"
                                    value="${currentTime}"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; box-sizing: border-box;"
                                />
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button 
                                    type="button"
                                    onclick="closeEditPunchModal()"
                                    style="flex: 1; padding: 14px; background: #f1f5f9; color: #475569; font-size: ${baseSize * 0.85}px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                    onmouseover="this.style.background='#e2e8f0'"
                                    onmouseout="this.style.background='#f1f5f9'"
                                >
                                    Batal
                                </button>
                                <button 
                                    type="submit"
                                    ${state.loading ? 'disabled' : ''}
                                    style="flex: 1; padding: 14px; background: ${state.loading ? '#94a3b8' : primaryColor}; color: white; font-size: ${baseSize * 0.85}px; font-weight: 800; border: none; border-radius: 12px; cursor: ${state.loading ? 'not-allowed' : 'pointer'}; text-transform: uppercase; box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;"
                                    onmouseover="if(!${state.loading}) this.style.transform='translateY(-2px)'"
                                    onmouseout="this.style.transform='translateY(0)'"
                                >
                                    ${state.loading ? '<div class="loading-spinner"></div>' : ''} Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderEditUserModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            if (!state.editUserModal) return '';
            
            const user = state.users.find(u => u.__backendId === state.editUserModal);
            if (!user) return '';
            
            return `
                <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px);">
                    <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 24px; padding: 32px; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 2px solid ${primaryColor};">
                        <div style="font-size: ${baseSize * 1.4}px; font-weight: 800; text-align: center; color: ${textColor}; text-transform: uppercase; margin-bottom: 24px;">
                            Edit Pengguna
                        </div>
                        
                        <form onsubmit="submitEditUser(event)">
                            <div style="margin-bottom: 20px;">
                                <label for="edit-name" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Nama Penuh
                                </label>
                                <input 
                                    type="text" 
                                    id="edit-name" 
                                    required 
                                    value="${user.name}"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; text-transform: uppercase; box-sizing: border-box;"
                                />
                            </div>

                            <div style="margin-bottom: 24px;">
                                <label for="edit-ic" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    No. Kad Pengenalan
                                </label>
                                <input 
                                    type="text" 
                                    id="edit-ic" 
                                    required 
                                    inputmode="numeric"
                                    value="${user.ic}"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; box-sizing: border-box;"
                                />
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button 
                                    type="button"
                                    onclick="closeEditUserModal()"
                                    style="flex: 1; padding: 14px; background: #f1f5f9; color: #475569; font-size: ${baseSize * 0.85}px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                    onmouseover="this.style.background='#e2e8f0'"
                                    onmouseout="this.style.background='#f1f5f9'"
                                >
                                    Batal
                                </button>
                                <button 
                                    type="submit"
                                    style="flex: 1; padding: 14px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.85}px; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4); transition: all 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'"
                                    onmouseout="this.style.transform='translateY(0)'"
                                >
                                    Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderNoteModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            if (!state.showNoteModal) return '';
            
            const { type, userName, dateStr, currentNote, currentStatus } = state.showNoteModal;
            const isEdit = type === 'edit';
            
            return `
                <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px);">
                    <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 24px; padding: 32px; max-width: 500px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 2px solid ${primaryColor};">
                        <div style="font-size: ${baseSize * 1.4}px; font-weight: 800; text-align: center; color: ${textColor}; text-transform: uppercase; margin-bottom: 12px;">
                            ${isEdit ? 'Edit Catatan' : 'Tambah Catatan'}
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 24px; border-left: 4px solid ${primaryColor};">
                            <div style="font-size: ${baseSize * 0.9}px; font-weight: 700; color: ${textColor}; margin-bottom: 4px;">
                                ${userName}
                            </div>
                            <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; margin-bottom: ${isEdit ? '8px' : '0'};">
                                ${dateStr}
                            </div>
                            ${isEdit ? `
                                <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor};">
                                    Status: <span style="font-weight: 700; color: ${textColor};">${currentStatus}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <form onsubmit="submitNoteModal(event)">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Pilih Status
                                </label>
                                <div style="display: flex; gap: 12px;">
                                    <button 
                                        type="button"
                                        id="status-hadir"
                                        onclick="selectNoteStatus('hadir')"
                                        style="flex: 1; padding: 12px; background: #dcfce7; color: #166534; font-size: ${baseSize * 0.85}px; font-weight: 700; border: 3px solid #dcfce7; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                    >
                                        ‚úì HADIR
                                    </button>
                                    <button 
                                        type="button"
                                        id="status-tidak-hadir"
                                        onclick="selectNoteStatus('tidak-hadir')"
                                        style="flex: 1; padding: 12px; background: #fecaca; color: #7f1d1d; font-size: ${baseSize * 0.85}px; font-weight: 700; border: 3px solid #fecaca; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                    >
                                        ‚úó TIDAK HADIR
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label for="note-input" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    ${isEdit ? 'Catatan Baru' : 'Catatan'}
                                </label>
                                <textarea 
                                    id="note-input" 
                                    placeholder="${isEdit ? 'Masukkan catatan baru...' : 'Contoh: Cuti sakit, meeting luar, dll.'}"
                                    style="width: 100%; min-height: 120px; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; resize: vertical; font-family: inherit; font-weight: 600; box-sizing: border-box;"
                                >${currentNote}</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button 
                                    type="button"
                                    onclick="closeNoteModal()"
                                    style="flex: 1; padding: 14px; background: #f1f5f9; color: #475569; font-size: ${baseSize * 0.85}px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                    onmouseover="this.style.background='#e2e8f0'"
                                    onmouseout="this.style.background='#f1f5f9'"
                                >
                                    Batal
                                </button>
                                <button 
                                    type="submit"
                                    ${state.loading ? 'disabled' : ''}
                                    style="flex: 1; padding: 14px; background: ${state.loading ? '#94a3b8' : primaryColor}; color: white; font-size: ${baseSize * 0.85}px; font-weight: 800; border: none; border-radius: 12px; cursor: ${state.loading ? 'not-allowed' : 'pointer'}; text-transform: uppercase; box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4); transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;"
                                    onmouseover="if(!${state.loading}) this.style.transform='translateY(-2px)'"
                                    onmouseout="this.style.transform='translateY(0)'"
                                >
                                    ${state.loading ? '<div class="loading-spinner"></div>' : ''} Simpan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderPunchModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            const actionMap = {
                'masuk': 'PUNCH IN',
                'keluar': 'PUNCH OUT',
                'th': 'TIDAK HADIR',
                'bersebab': 'BERSEBAB'
            };
            const actionText = actionMap[state.punchModalAction] || 'DAFTAR';
            
            if (state.punchModalAction === 'th' || state.punchModalAction === 'bersebab') {
                const thOptions = ["CRK", "CTR", "CUTI REHAT", "MC (Sakit)", "CUTI KUARANTIN", "CUTI BERSALIN", "LAIN - LAIN"];
                const bOptions = ["MESYUARAT", "BENGKEL", "KURSUS", "KOLOKIUM", "URUSAN RASMI SEKOLAH", "4 HOUR TIME SLIP", "LAIN - LAIN"];
                const currentOptions = state.punchModalAction === 'th' ? thOptions : bOptions;
                
                return `
                    <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px);">
                        <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 20px; padding: 32px; max-width: 420px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 2px solid ${state.punchModalAction === 'th' ? '#ef4444' : '#f59e0b'};">
                            <div style="font-size: ${baseSize * 1.4}px; font-weight: 800; color: ${state.punchModalAction === 'th' ? '#ef4444' : '#f59e0b'}; margin-bottom: 12px; text-transform: uppercase; text-align: center;">
                                ${actionText}
                            </div>
                            <div style="font-size: ${baseSize * 0.85}px; color: ${secondaryColor}; margin-bottom: 24px; text-align: center; font-weight: 600;">
                                Sila pilih sebab ${state.punchModalAction === 'th' ? 'tidak hadir' : 'bersebab'}
                            </div>
                            
                            <form onsubmit="submitPunchWithNote(event)">
                                <label style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Kategori
                                </label>
                                <select 
                                    id="punch-category"
                                    required
                                    onchange="handleCategoryChange(this.value)"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid ${state.punchModalAction === 'th' ? '#ef4444' : '#f59e0b'}; border-radius: 12px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; margin-bottom: 16px; font-weight: 700; cursor: pointer;"
                                >
                                    <option value="">-- SILA PILIH --</option>
                                    ${currentOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                                
                                <div id="custom-note-container" style="display: none; margin-bottom: 20px;">
                                    <label style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Butiran Tambahan
                                    </label>
                                    <textarea 
                                        id="punch-note"
                                        placeholder="Sila nyatakan butiran..."
                                        style="width: 100%; min-height: 80px; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; resize: vertical; font-family: inherit; font-weight: 600;"
                                    ></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-top: 24px;">
                                    <button 
                                        type="button"
                                        onclick="closePunchModal()"
                                        style="flex: 1; padding: 14px; background: #f1f5f9; color: #475569; font-size: ${baseSize * 0.85}px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                        onmouseover="this.style.background='#e2e8f0'"
                                        onmouseout="this.style.background='#f1f5f9'"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        type="submit"
                                        style="flex: 1; padding: 14px; background: ${state.punchModalAction === 'th' ? '#ef4444' : '#f59e0b'}; color: white; font-size: ${baseSize * 0.85}px; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 16px ${state.punchModalAction === 'th' ? 'rgba(239, 68, 68, 0.4)' : 'rgba(245, 158, 11, 0.4)'}; transition: all 0.2s;"
                                        onmouseover="this.style.transform='translateY(-2px)'"
                                        onmouseout="this.style.transform='translateY(0)'"
                                    >
                                        Sahkan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 16px; padding: 32px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="font-size: ${baseSize * 1.3}px; font-weight: 800; color: ${textColor}; margin-bottom: 8px; text-transform: uppercase;">
                            ${actionText}
                        </div>
                        <div style="font-size: ${baseSize * 0.85}px; color: ${secondaryColor}; margin-bottom: 24px;">
                            Tambah nota (pilihan)
                        </div>
                        
                        <form onsubmit="submitPunchWithNote(event)">
                            <textarea 
                                id="punch-note"
                                placeholder="Contoh: Lambat kerana kecemasan"
                                style="width: 100%; min-height: 100px; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; resize: vertical; font-family: inherit; margin-bottom: 20px;"
                            ></textarea>
                            
                            <div style="display: flex; gap: 12px;">
                                <button 
                                    type="button"
                                    onclick="closePunchModal()"
                                    style="flex: 1; padding: 12px; background: #e2e8f0; color: ${textColor}; font-size: ${baseSize * 0.9}px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;"
                                >
                                    Batal
                                </button>
                                <button 
                                    type="submit"
                                    style="flex: 1; padding: 12px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.9}px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer;"
                                >
                                    ${actionText}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDeleteModal(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            const { type, backendId } = state.deleteModal;
            
            if (type === 'user') {
                const user = state.users.find(u => u.__backendId === backendId);
                if (!user) return '';
                
                return `
                    <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px);">
                        <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 24px; padding: 24px; max-width: 420px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 2px solid #ef4444;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; color: #dc2626;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </div>
                            
                            <div style="font-size: ${baseSize * 1.3}px; font-weight: 800; text-align: center; color: #0f172a; text-transform: uppercase; margin-bottom: 12px;">
                                Hapus Pengguna?
                            </div>
                            
                            <div style="background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: ${baseSize * 0.7}px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                                    Maklumat Pengguna
                                </div>
                                <div style="font-size: ${baseSize * 1.1}px; font-weight: 800; color: #0f172a; margin-bottom: 4px; text-transform: uppercase;">
                                    ${user.name}
                                </div>
                                <div style="font-size: ${baseSize * 0.85}px; color: #64748b; font-weight: 600; margin-bottom: 2px;">
                                    IC: ${user.ic}
                                </div>
                                <div style="font-size: ${baseSize * 0.85}px; color: #64748b; font-weight: 600;">
                                    Jawatan: <span style="text-transform: uppercase; font-weight: 700;">${user.role}</span>
                                </div>
                            </div>
                            
                            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 14px; margin-bottom: 24px; border-left: 4px solid #ef4444;">
                                <div style="font-size: ${baseSize * 0.8}px; color: #991b1b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px;">
                                       Ô∏è Amaran: Memadam Kekal
                                </div>
                                <div style="font-size: ${baseSize * 0.75}px; color: #7f1d1d; line-height: 1.5;">
                                    Tindakan ini akan <strong>MEMADAM KEKAL</strong> profil pengguna dan <strong>SEMUA REKOD KEHADIRAN</strong> mereka. 
                                    <br><br>
                                    <span style="font-weight: 800;">Tindakan ini TIDAK BOLEH dibatalkan!</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button 
                                    onclick="closeDeleteModal()"
                                    style="flex: 1; padding: 14px; background: #f1f5f9; color: #475569; font-size: ${baseSize * 0.85}px; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; transition: all 0.2s;"
                                    onmouseover="this.style.background='#e2e8f0'"
                                    onmouseout="this.style.background='#f1f5f9'"
                                >
                                    Batal
                                </button>
                                <button 
                                    onclick="confirmDelete()"
                                    style="flex: 1; padding: 14px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: ${baseSize * 0.85}px; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 16px rgba(239, 68, 68, 0.4); transition: all 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 24px rgba(239, 68, 68, 0.5)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(239, 68, 68, 0.4)'"
                                >
                                    Ya, Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const deleteText = 'rekod kehadiran';
                
                return `
                    <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div onclick="event.stopPropagation()" style="background: ${surfaceColor}; border-radius: 16px; padding: 32px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="font-size: ${baseSize * 1.3}px; font-weight: 800; color: #ef4444; margin-bottom: 8px;">
                                ‚ö†Ô∏è Pengesahan Padam
                            </div>
                            <div style="font-size: ${baseSize}px; color: ${textColor}; margin-bottom: 24px;">
                                Adakah anda pasti ingin memadam ${deleteText} ini? Tindakan ini tidak boleh dibatalkan.
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button 
                                    onclick="closeDeleteModal()"
                                    style="flex: 1; padding: 12px; background: #e2e8f0; color: ${textColor}; font-size: ${baseSize * 0.9}px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;"
                                >
                                    Batal
                                </button>
                                <button 
                                    onclick="confirmDelete()"
                                    style="flex: 1; padding: 12px; background: #ef4444; color: white; font-size: ${baseSize * 0.9}px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer;"
                                >
                                    Ya, Padam
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderLogin(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            return `
                <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="width: 100%; max-width: 500px; background: ${surfaceColor}; border-radius: 16px; padding: 48px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 32px;">
                            <div style="font-size: ${baseSize * 2}px; font-weight: 800; color: ${textColor}; margin-bottom: 8px;">
                                ${config.app_title || defaultConfig.app_title}
                            </div>
                            <div style="font-size: ${baseSize * 0.9}px; color: ${secondaryColor};">
                                ${config.welcome_message || defaultConfig.welcome_message}
                            </div>
                        </div>
                        
                        <form onsubmit="handleLogin(event)">
                            <div style="margin-bottom: 24px;">
                                <label for="ic" style="display: block; font-size: ${baseSize * 0.9}px; font-weight: 600; color: ${textColor}; margin-bottom: 8px;">
                                    No. Kad Pengenalan
                                </label>
                                <input 
                                    type="text" 
                                    id="ic" 
                                    required 
                                    placeholder="Masukkan No. IC"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: ${baseSize}px; color: ${textColor}; background: white; box-sizing: border-box;"
                                />
                            </div>
                            
                            <button 
                                type="submit"
                                style="width: 100%; padding: 14px; background: ${primaryColor}; color: white; font-size: ${baseSize}px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                onmouseover="this.style.opacity='0.9'"
                                onmouseout="this.style.opacity='1'"
                            >
                                ${config.login_button_text || defaultConfig.login_button_text}
                            </button>
                        </form>

                        <div style="margin-top: 24px; text-align: center;">
                            <button 
                                onclick="state.view='register'; render();"
                                style="color: ${primaryColor}; font-size: ${baseSize * 0.9}px; font-weight: 600; background: none; border: none; cursor: pointer; text-decoration: underline;"
                            >
                                ${config.register_button_text || defaultConfig.register_button_text}
                            </button>
                        </div>

                        <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; font-weight: 600; line-height: 1.6;">
                                Powered By GB Akbar @2026<br>Hak Cipta Terpelihara
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRegister(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            const showShiftSelection = state.regRole === 'akp';
            
            return `
                <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="width: 100%; max-width: 500px; background: ${surfaceColor}; border-radius: 16px; padding: 48px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 32px;">
                            <div style="font-size: ${baseSize * 1.8}px; font-weight: 800; color: ${textColor}; margin-bottom: 8px; text-transform: uppercase;">
                                Pendaftaran Baru
                            </div>
                        </div>
                        
                        <form onsubmit="handleRegister(event)">
                            <div style="margin-bottom: 20px;">
                                <label for="reg-name" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Nama Penuh
                                </label>
                                <input 
                                    type="text" 
                                    id="reg-name" 
                                    required 
                                    placeholder="NAMA PENUH"
                                    value="${state.regName || ''}"
                                    oninput="state.regName = this.value"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; text-transform: uppercase; box-sizing: border-box;"
                                />
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label for="reg-ic" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    No. Kad Pengenalan
                                </label>
                                <input 
                                    type="text" 
                                    id="reg-ic" 
                                    required 
                                    inputmode="numeric"
                                    placeholder="NO. IC (TANPA -)"
                                    value="${state.regIc || ''}"
                                    oninput="state.regIc = this.value"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; box-sizing: border-box;"
                                />
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label for="reg-role" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Jawatan
                                </label>
                                <select 
                                    id="reg-role" 
                                    required
                                    onchange="handleRoleChange(this.value)"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; cursor: pointer; box-sizing: border-box;"
                                >
                                    <option value="">-- PILIH --</option>
                                    <option value="guru" ${state.regRole === 'guru' ? 'selected' : ''}>GURU</option>
                                    <option value="guru besar" ${state.regRole === 'guru besar' ? 'selected' : ''}>GURU BESAR</option>
                                    <option value="akp" ${state.regRole === 'akp' ? 'selected' : ''}>AKP</option>
                                    <option value="pentadbir" ${state.regRole === 'pentadbir' ? 'selected' : ''}>PENTADBIR</option>
                                </select>
                            </div>

                            ${showShiftSelection ? `
                            <div style="animation: fadeIn 0.3s ease-in; margin-bottom: 20px;">
                                <label for="reg-shift" style="display: block; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Pilih Syif Waktu Kerja
                                </label>
                                <select 
                                    id="reg-shift" 
                                    required
                                    onchange="state.regShift = this.value"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: ${baseSize}px; color: ${textColor}; background: white; font-weight: 700; cursor: pointer; box-sizing: border-box;"
                                >
                                    <option value="">-- PILIH SYIF --</option>
                                    <option value="7.00 - 4.00" ${state.regShift === '7.00 - 4.00' ? 'selected' : ''}>7.00 PAGI - 4.00 PETANG</option>
                                    <option value="7.30 - 4.30" ${state.regShift === '7.30 - 4.30' ? 'selected' : ''}>7.30 PAGI - 4.30 PETANG</option>
                                    <option value="8.00 - 5.00" ${state.regShift === '8.00 - 5.00' ? 'selected' : ''}>8.00 PAGI - 5.00 PETANG</option>
                                </select>
                            </div>
                            ` : ''}
                            
                            <button 
                                type="submit"
                                ${state.loading ? 'disabled' : ''}
                                style="width: 100%; padding: 16px; background: ${state.loading ? '#94a3b8' : primaryColor}; color: white; font-size: ${baseSize}px; font-weight: 800; border: none; border-radius: 12px; cursor: ${state.loading ? 'not-allowed' : 'pointer'}; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; margin-top: 24px; box-shadow: 0 4px 12px ${primaryColor}40; opacity: ${state.loading ? '0.7' : '1'}; box-sizing: border-box;"
                            >
                                ${state.loading ? '<div class="loading-spinner"></div>' : ''} Sahkan Pendaftaran
                            </button>
                        </form>

                        <div style="margin-top: 16px; text-align: center;">
                            <button 
                                onclick="state.view='login'; state.regRole=null; state.regName=''; state.regIc=''; state.regShift=''; render();"
                                style="color: ${secondaryColor}; font-size: ${baseSize * 0.8}px; font-weight: 700; background: none; border: none; cursor: pointer; text-transform: uppercase; text-decoration: underline;"
                            >
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const today = `${day}/${month}/${year}`;
            
            const todayRecords = state.attendance.filter(r => 
                r.ic === state.currentUser.ic && 
                r.date === today
            );

            const lastClockIn = todayRecords.filter(r => r.action === 'masuk').sort((a, b) => b.timestamp - a.timestamp)[0];
            const lastClockOut = todayRecords.filter(r => r.action === 'keluar').sort((a, b) => b.timestamp - a.timestamp)[0];
            
            const isPunchIn = lastClockIn && !lastClockOut;
            const isCompleted = lastClockIn && lastClockOut;

            const recentRecords = state.attendance
                .filter(r => r.ic === state.currentUser.ic)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);

            const userCardColor = state.currentUser.card_color || 'yellow';
            const cardColorMap = {
                'green': { bg: 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)', border: '#86efac', text: '#166534' },
                'yellow': { bg: 'linear-gradient(135deg, #fef9c3 0%, #fef08a 100%)', border: '#fde047', text: '#854d0e' },
                'red': { bg: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 100%)', border: '#fca5a5', text: '#7f1d1d' }
            };
            const currentCardStyle = cardColorMap[userCardColor];

            return `
                <div style="min-height: 100%; padding: 24px;">
                    <div style="max-width: 1024px; margin: 0 auto;">
                        <div style="background: ${currentCardStyle.bg}; border: 3px solid ${currentCardStyle.border}; border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-size: ${baseSize * 1.8}px; font-weight: 800; color: ${currentCardStyle.text}; text-transform: uppercase;">
                                    ${state.currentUser.name}
                                </div>
                                <div style="font-size: ${baseSize * 0.85}px; color: ${currentCardStyle.text}; margin-top: 4px; font-weight: 600; text-transform: uppercase; opacity: 0.8;">
                                    ${state.currentUser.role} ${state.currentUser.shift !== 'Tidak Berkenaan' ? `‚Ä¢ SYIF ${state.currentUser.shift}` : ''}
                                </div>
                            </div>
                            <button 
                                onclick="handleLogout()"
                                style="padding: 10px 20px; background: ${currentCardStyle.text}; color: white; font-size: ${baseSize * 0.9}px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"
                            >
                                Log Keluar
                            </button>
                        </div>

                        <div style="background: ${surfaceColor}; border-radius: 16px; padding: 48px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-top: 4px solid ${primaryColor}; margin-bottom: 32px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 32px; margin-bottom: 32px;">
                                <div style="text-align: center;">
                                    <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; font-weight: 700; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Punch In Hari Ini
                                    </div>
                                    <div style="font-size: ${baseSize * 2.5}px; font-weight: 800; color: ${isPunchIn || isCompleted ? '#10b981' : textColor};">
                                        ${lastClockIn ? lastClockIn.time : '--:--'}
                                    </div>
                                </div>
                                
                                <div style="text-align: center;">
                                    <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; font-weight: 700; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">
                                        Punch Out Hari Ini
                                    </div>
                                    <div style="font-size: ${baseSize * 2.5}px; font-weight: 800; color: ${isCompleted ? '#10b981' : textColor};">
                                        ${lastClockOut ? lastClockOut.time : '--:--'}
                                    </div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                ${!isCompleted ? `
                                    <button 
                                        onclick="showPunchModal('${isPunchIn ? 'keluar' : 'masuk'}')"
                                        ${state.loading ? 'disabled' : ''}
                                        style="padding: 24px; background: ${isPunchIn ? '#f97316' : '#10b981'}; color: white; font-size: ${baseSize * 1.2}px; font-weight: 800; border: none; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: all 0.2s;"
                                        onmouseover="this.style.transform='scale(1.02)'"
                                        onmouseout="this.style.transform='scale(1)'"
                                    >
                                        ${state.loading ? '<div class="loading-spinner"></div>' : ''} ${isPunchIn ? 'PUNCH OUT' : 'PUNCH IN'}
                                    </button>
                                ` : `
                                    <div style="grid-column: 1 / -1; padding: 24px; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 16px; text-align: center; border: 2px solid #86efac;">
                                        <div style="font-size: ${baseSize * 0.9}px; color: #166534; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                                            ‚úì Status Rekod
                                        </div>
                                        <div style="font-size: ${baseSize * 1.5}px; font-weight: 800; color: #166534; text-transform: uppercase;">
                                            HADIR
                                        </div>
                                        <div style="font-size: ${baseSize * 0.85}px; color: #15803d; margin-top: 8px;">
                                            ${lastClockIn.time} - ${lastClockOut.time}
                                        </div>
                                        ${lastClockIn.note || lastClockOut.note ? `
                                            <div style="font-size: ${baseSize * 0.75}px; color: #166534; margin-top: 8px; font-weight: 600; font-style: italic;">
                                                ${lastClockIn.note || lastClockOut.note}
                                            </div>
                                        ` : ''}
                                    </div>
                                `}
                                
                                ${!lastClockIn && !isCompleted ? `
                                    <button 
                                        onclick="showPunchModal('th')"
                                        style="padding: 24px; background: #ef4444; color: white; font-size: ${baseSize * 0.8}px; font-weight: 800; border: none; border-radius: 16px; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);"
                                    >
                                        Tidak Hadir
                                    </button>
                                    <button 
                                        onclick="showPunchModal('bersebab')"
                                        style="padding: 24px; background: #f59e0b; color: white; font-size: ${baseSize * 0.8}px; font-weight: 800; border: none; border-radius: 16px; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);"
                                    >
                                        Bersebab
                                    </button>
                                ` : ''}
                            </div>
                        </div>

                        <div style="background: ${surfaceColor}; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <div style="font-size: ${baseSize * 1.2}px; font-weight: 700; color: ${textColor}; margin-bottom: 20px;">
                                Rekod Kehadiran Terkini
                            </div>
                            ${recentRecords.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: ${secondaryColor}; font-size: ${baseSize}px;">
                                    Tiada rekod kehadiran lagi
                                </div>
                            ` : `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                                <th style="padding: 12px; text-align: left; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">TARIKH</th>
                                                <th style="padding: 12px; text-align: left; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">MASA</th>
                                                <th style="padding: 12px; text-align: left; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">TINDAKAN</th>
                                                <th style="padding: 12px; text-align: left; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">NOTA</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${recentRecords.map(r => `
                                                <tr style="border-bottom: 1px solid #f1f5f9;">
                                                    <td style="padding: 12px; font-size: ${baseSize * 0.9}px; color: ${textColor};">${r.date}</td>
                                                    <td style="padding: 12px; font-size: ${baseSize * 0.9}px; color: ${textColor};">${r.time}</td>
                                                    <td style="padding: 12px;">
                                                        <span style="display: inline-block; padding: 4px 12px; background: ${r.action === 'masuk' ? '#dcfce7' : r.action === 'keluar' ? '#fee2e2' : r.action === 'th' ? '#fecaca' : '#fef3c7'}; color: ${r.action === 'masuk' ? '#166534' : r.action === 'keluar' ? '#991b1b' : r.action === 'th' ? '#7f1d1d' : '#92400e'}; border-radius: 6px; font-size: ${baseSize * 0.8}px; font-weight: 600; text-transform: uppercase;">
                                                            ${r.action === 'masuk' ? 'MASUK' : r.action === 'keluar' ? 'KELUAR' : r.action === 'th' ? 'TIDAK HADIR' : 'BERSEBAB'}
                                                        </span>
                                                    </td>
                                                    <td style="padding: 12px; font-size: ${baseSize * 0.85}px; color: ${secondaryColor};">${r.note || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const today = `${day}/${month}/${year}`;
            
            const staff = state.users.filter(u => u.role === 'guru' || u.role === 'akp' || u.role === 'guru besar');
            const totalStaff = staff.length;
            // Kira 'masuk' dan 'bersebab' sebagai hadir, KECUALI jika catatan mengandungi "CUTI BERSALIN". Cuti (th) TIDAK dikira sebagai hadir
            const todayAttendance = state.attendance.filter(r => {
                const user = state.users.find(u => u.ic === r.ic);
                if (!user || !(user.role === 'guru' || user.role === 'akp' || user.role === 'guru besar')) return false;
                if (r.date !== today) return false;
                
                if (r.action === 'masuk') return true;
                if (r.action === 'bersebab') {
                    const noteContent = (r.note || '').toUpperCase();
                    return !noteContent.includes('CUTI BERSALIN');
                }
                return false;
            });
            const uniqueStaffToday = new Set(todayAttendance.map(r => r.ic)).size;

            return `
                <div style="min-height: 100%; padding: 24px;">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-size: ${baseSize * 1.8}px; font-weight: 800; color: ${textColor}; text-transform: uppercase;">
                                    Panel Pentadbir
                                </div>
                                <div style="font-size: ${baseSize * 0.85}px; color: ${secondaryColor}; margin-top: 4px; font-weight: 600;">
                                    ${state.currentUser.name} (${state.currentUser.ic})
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button 
                                    onclick="showEditUserModal('${state.currentUser.__backendId}')"
                                    style="padding: 10px 20px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.9}px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;"
                                >
                                    ‚úèÔ∏è Edit Profil
                                </button>
                                <button 
                                    onclick="handleLogout()"
                                    style="padding: 10px 20px; background: ${secondaryColor}; color: white; font-size: ${baseSize * 0.9}px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;"
                                >
                                    Log Keluar
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
                            <button 
                                onclick="state.adminTab='daily'; render();"
                                style="padding: 10px 20px; background: ${state.adminTab === 'daily' ? primaryColor : surfaceColor}; color: ${state.adminTab === 'daily' ? 'white' : textColor}; font-size: ${baseSize * 0.75}px; font-weight: 700; border: ${state.adminTab === 'daily' ? 'none' : '2px solid #e2e8f0'}; border-radius: 12px; cursor: pointer; text-transform: uppercase;"
                            >
                                Harian
                            </button>
                            <button 
                                onclick="state.adminTab='monthly'; state.view='report'; render();"
                                style="padding: 10px 20px; background: ${surfaceColor}; color: ${textColor}; font-size: ${baseSize * 0.75}px; font-weight: 700; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-transform: uppercase;"
                            >
                                Bulanan
                            </button>
                            <button 
                                onclick="state.adminTab='staff'; render();"
                                style="padding: 10px 20px; background: ${state.adminTab === 'staff' ? '#ef4444' : surfaceColor}; color: ${state.adminTab === 'staff' ? 'white' : textColor}; font-size: ${baseSize * 0.75}px; font-weight: 700; border: ${state.adminTab === 'staff' ? 'none' : '2px solid #e2e8f0'}; border-radius: 12px; cursor: pointer; text-transform: uppercase; margin-left: auto;"
                            >
                                Pengurusan Staf
                            </button>
                        </div>

                        ${state.adminTab === 'staff' ? `
                            <div style="background: ${surfaceColor}; border-radius: 16px; padding: 32px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <div style="font-size: ${baseSize * 1.3}px; font-weight: 800; color: ${textColor}; text-transform: uppercase;">
                                        Pengurusan Pengguna
                                    </div>
                                </div>
                                ${staff.length === 0 ? `
                                    <div style="text-align: center; padding: 40px; color: ${secondaryColor}; font-size: ${baseSize}px;">
                                        Tiada kakitangan didaftarkan lagi
                                    </div>
                                ` : `
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                                    <th style="padding: 16px; text-align: left; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Nama</th>
                                                    <th style="padding: 16px; text-align: left; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">No. IC</th>
                                                    <th style="padding: 16px; text-align: left; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Jawatan</th>
                                                    <th style="padding: 16px; text-align: left; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Syif</th>
                                                    <th style="padding: 16px; text-align: center; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Tindakan / Kad</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${staff.filter(u => u.role !== 'pentadbir').sort((a,b) => a.name.localeCompare(b.name)).map(u => {
                                                    return `
                                                    <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                                                        <td style="padding: 16px;">
                                                            <div style="font-size: ${baseSize * 0.9}px; color: ${textColor}; font-weight: 700; text-transform: uppercase;">${u.name}</div>
                                                        </td>
                                                        <td style="padding: 16px; font-size: ${baseSize * 0.85}px; color: ${secondaryColor};">${u.ic}</td>
                                                        <td style="padding: 16px;">
                                                            <span style="display: inline-block; padding: 6px 12px; background: ${u.role === 'akp' ? '#fef3c7' : '#f3f4f6'}; color: ${u.role === 'akp' ? '#92400e' : '#374151'}; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 700; text-transform: uppercase;">
                                                                ${u.role}
                                                            </span>
                                                        </td>
                                                        <td style="padding: 16px; font-size: ${baseSize * 0.85}px; color: ${textColor}; font-weight: 600;">${u.shift}</td>
                                                        <td style="padding: 16px; text-align: center;">
                                                            <div style="display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: wrap;">
                                                                <select 
                                                                    onchange="changeCardColor('${u.__backendId}', this.value)"
                                                                    style="padding: 6px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 600; cursor: pointer; background: white;"
                                                                >
                                                                    <option value="green" ${(u.card_color || 'yellow') === 'green' ? 'selected' : ''}>üü¢ HIJAU</option>
                                                                    <option value="yellow" ${(u.card_color || 'yellow') === 'yellow' ? 'selected' : ''}>üü° KUNING</option>
                                                                    <option value="red" ${(u.card_color || 'yellow') === 'red' ? 'selected' : ''}>üî¥ MERAH</option>
                                                                </select>
                                                                <button 
                                                                    onclick="showEditUserModal('${u.__backendId}')"
                                                                    style="padding: 6px 12px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.7}px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s;"
                                                                    onmouseover="this.style.background='#2563eb'"
                                                                    onmouseout="this.style.background='${primaryColor}'"
                                                                >
                                                                    Edit
                                                                </button>
                                                                ${u.ic !== state.currentUser.ic ? `
                                                                    <button 
                                                                        onclick='promptDeleteUser(${JSON.stringify(u).replace(/'/g, "&apos;")})'
                                                                        style="padding: 6px 12px; background: #dc2626; color: white; font-size: ${baseSize * 0.7}px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3); transition: all 0.2s;"
                                                                        onmouseover="this.style.background='#b91c1c'"
                                                                        onmouseout="this.style.background='#dc2626'"
                                                                    >
                                                                        Hapus
                                                                    </button>
                                                                ` : ''}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;}).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `}
                            </div>
                        ` : state.adminTab === 'daily' ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                                <div style="background: ${surfaceColor}; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; font-weight: 700; margin-bottom: 8px; text-transform: uppercase;">
                                        Jumlah Kakitangan
                                    </div>
                                    <div style="font-size: ${baseSize * 2.5}px; font-weight: 800; color: ${textColor};">
                                        ${totalStaff}
                                    </div>
                                </div>

                                <div style="background: ${surfaceColor}; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; font-weight: 700; margin-bottom: 8px; text-transform: uppercase;">
                                        Hadir Hari Ini
                                    </div>
                                    <div style="font-size: ${baseSize * 2.5}px; font-weight: 800; color: #10b981;">
                                        ${uniqueStaffToday}
                                    </div>
                                </div>

                                <div style="background: ${surfaceColor}; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <div style="font-size: ${baseSize * 0.75}px; color: ${secondaryColor}; font-weight: 700; margin-bottom: 8px; text-transform: uppercase;">
                                        Peratus Kehadiran
                                    </div>
                                    <div style="font-size: ${baseSize * 2.5}px; font-weight: 800; color: ${totalStaff > 0 ? '#3b82f6' : textColor};">
                                        ${totalStaff > 0 ? Math.round((uniqueStaffToday / totalStaff) * 100) : 0}%
                                    </div>
                                </div>
                            </div>

                            <div style="background: ${surfaceColor}; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid #e2e8f0;">
                                <div style="padding: 20px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 12px;">
                                    <div style="font-size: ${baseSize * 1.1}px; font-weight: 800; color: ${textColor}; text-transform: uppercase;">
                                        Rekod Harian (${today})
                                    </div>
                                    <button 
                                        onclick="printDailyReport()"
                                        style="padding: 8px 16px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.7}px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase;"
                                    >
                                        üìÑ CETAK
                                    </button>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                                <th style="padding: 16px; text-align: left; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Staf</th>
                                                <th style="padding: 16px; text-align: center; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Masa Masuk</th>
                                                <th style="padding: 16px; text-align: center; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Masa Keluar</th>
                                                <th style="padding: 16px; text-align: center; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Status</th>
                                                <th style="padding: 16px; text-align: left; font-size: ${baseSize * 0.75}px; font-weight: 700; color: ${secondaryColor}; text-transform: uppercase;">Catatan</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${staff.sort((a,b) => a.name.localeCompare(b.name)).map(u => {
                                                const dayRecords = state.attendance.filter(a => a.ic === u.ic && a.date === today);
                                                const clockIn = dayRecords.find(r => r.action === 'masuk');
                                                const clockOut = dayRecords.find(r => r.action === 'keluar');
                                                const thRecord = dayRecords.find(r => r.action === 'th');
                                                const bersebabRecord = dayRecords.find(r => r.action === 'bersebab');
                                                
                                                let statusHtml = '';
                                                let noteText = '';
                                                
                                                if (thRecord) {
                                                    statusHtml = `<span style="display: inline-block; padding: 6px 12px; background: #fecaca; color: #7f1d1d; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 800; text-transform: uppercase;">Tidak Hadir</span>`;
                                                    noteText = thRecord.note || '-';
                                                } else if (bersebabRecord) {
                                                    // Semak jika catatan mengandungi "CUTI BERSALIN" - jika ya, status = TIDAK HADIR
                                                    const noteContent = (bersebabRecord.note || '').toUpperCase();
                                                    if (noteContent.includes('CUTI BERSALIN')) {
                                                        statusHtml = `<span style="display: inline-block; padding: 6px 12px; background: #fecaca; color: #7f1d1d; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 800; text-transform: uppercase;">Tidak Hadir</span>`;
                                                    } else {
                                                        statusHtml = `<span style="display: inline-block; padding: 6px 12px; background: #dcfce7; color: #166534; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 800; text-transform: uppercase;">Hadir</span>`;
                                                    }
                                                    noteText = bersebabRecord.note || '-';
                                                } else if (clockIn) {
                                                    statusHtml = `<span style="display: inline-block; padding: 6px 12px; background: #dcfce7; color: #166534; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 800; text-transform: uppercase;">Hadir</span>`;
                                                    noteText = clockIn.note || clockOut?.note || '-';
                                                } else {
                                                    statusHtml = `<span style="display: inline-block; padding: 6px 12px; background: #fee2e2; color: #991b1b; border-radius: 8px; font-size: ${baseSize * 0.7}px; font-weight: 800; text-transform: uppercase;">Tidak Hadir</span>`;
                                                    noteText = '-';
                                                }

                                                return `
                                                    <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                                                        <td style="padding: 16px;">
                                                            <div style="font-size: ${baseSize * 0.9}px; color: ${textColor}; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">${u.name}</div>
                                                            <div style="font-size: ${baseSize * 0.7}px; color: ${secondaryColor}; font-weight: 600;">${u.ic} ‚Ä¢ ${u.role.toUpperCase()}</div>
                                                        </td>
                                                        <td style="padding: 16px; text-align: center; font-size: ${baseSize * 0.85}px; color: ${textColor}; font-weight: 700;">
                                                            ${clockIn ? clockIn.time : '--:--'}
                                                            ${clockIn ? `<button onclick="editPunchRecord('${clockIn.__backendId}', 'in')" type="button" style="margin-left: 4px; padding: 2px 6px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.6}px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>` : ''}
                                                        </td>
                                                        <td style="padding: 16px; text-align: center; font-size: ${baseSize * 0.85}px; color: ${textColor}; font-weight: 700;">
                                                            ${clockOut ? clockOut.time : '--:--'}
                                                            ${clockOut ? `<button onclick="editPunchRecord('${clockOut.__backendId}', 'out')" type="button" style="margin-left: 4px; padding: 2px 6px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.6}px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>` : ''}
                                                        </td>
                                                        <td style="padding: 16px; text-align: center;">
                                                            ${statusHtml}
                                                        </td>
                                                        <td style="padding: 16px; font-size: ${baseSize * 0.8}px; color: ${textColor}; font-style: ${noteText === '-' ? 'normal' : 'italic'};">
                                                            ${noteText}
                                                            ${!clockIn && !thRecord && !bersebabRecord ? `
                                                                <button 
                                                                    onclick="addAdminNote('${u.ic}', '${today}')"
                                                                    type="button"
                                                                    style="margin-left: 8px; padding: 4px 10px; background: ${primaryColor}; color: white; font-size: ${baseSize * 0.65}px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; text-transform: uppercase;"
                                                                >
                                                                    + Catatan
                                                                </button>
                                                            ` : ''}
                                                            ${clockIn || thRecord || bersebabRecord ? `
                                                                <button 
                                                                    onclick="editDailyRecord('${u.ic}', '${today}')"
                                                                    type="button"
                                                                    style="margin-left: 8px; padding: 4px 10px; background: #f59e0b; color: white; font-size: ${baseSize * 0.65}px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; text-transform: uppercase;"
                                                                >
                                                                    ‚úèÔ∏è Edit
                                                                </button>
                                                            ` : ''}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderReport(config, baseSize, surfaceColor, textColor, primaryColor, secondaryColor) {
            const staffList = state.users.filter(u => u.role === 'guru' || u.role === 'akp' || u.role === 'guru besar');
            
            if (!state.selectedStaffIc && staffList.length > 0) {
                state.selectedStaffIc = staffList[0].ic;
            }

            const selectedStaff = state.users.find(u => u.ic === state.selectedStaffIc);
            
            const monthRecords = selectedStaff ? state.attendance.filter(r => {
                if (r.ic !== state.selectedStaffIc) return false;
                
                // Parse DD/MM/YYYY format
                const parts = r.date.split('/');
                if (parts.length !== 3) return false;
                
                const recordDay = parseInt(parts[0], 10);
                const recordMonth = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
                const recordYear = parseInt(parts[2], 10);
                
                return recordMonth === state.selectedMonth && recordYear === state.selectedYear;
            }).sort((a, b) => {
                const partsA = a.date.split('/');
                const partsB = b.date.split('/');
                const dateA = new Date(parseInt(partsA[2]), parseInt(partsA[1]) - 1, parseInt(partsA[0]));
                const dateB = new Date(parseInt(partsB[2]), parseInt(partsB[1]) - 1, parseInt(partsB[0]));
                return dateA - dateB;
            }) : [];

            const daysInMonth = new Date(state.selectedYear, state.selectedMonth + 1, 0).getDate();
            const dailyRecords = {};
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const monthStr = String(state.selectedMonth + 1).padStart(2, '0');
                const dateStr = `${dayStr}/${monthStr}/${state.selectedYear}`;
                
                const dayRecords = monthRecords.filter(r => r.date === dateStr);
                const clockIn = dayRecords.find(r => r.action === 'masuk');
                const clockOut = dayRecords.find(r => r.action === 'keluar');
                const thRecord = dayRecords.find(r => r.action === 'th');
                const bersebabRecord = dayRecords.find(r => r.action === 'bersebab');
                
                const testDate = new Date(state.selectedYear, state.selectedMonth, day);
                const dayOfWeek = testDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let status = '-';
                let note = '';
                
                if (isWeekend) {
                    status = 'C';
                    note = 'Cuti Hujung Minggu';
                } else if (thRecord) {
                    status = 'Tidak Hadir';
                    note = thRecord.note || '';
                } else if (bersebabRecord) {
                    status = 'Hadir';
                    note = bersebabRecord.note || '';
                } else if (clockIn) {
                    status = clockOut ? 'Hadir' : 'Masuk sahaja';
                    note = clockIn.note || clockOut?.note || '';
                }
                
                dailyRecords[day] = {
                    date: dateStr,
                    clockIn: clockIn ? clockIn.time : '-',
                    clockOut: clockOut ? clockOut.time : '-',
                    status: status,
                    note: note
                };
            }

            return `
                <div style="min-height: 100%; padding: 24px;">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px;">
                            <div style="font-size: ${baseSize * 1.8}px; font-weight: 800; color: ${textColor};">
                                Laporan Kehadiran Bulanan
                            </div>
                            <button 
                                onclick="state.view='admin'; render();"
                                style="padding: 10px 20px; background: ${secondaryColor}; color: white; font-size: ${baseSize * 0.9}px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;"
                            >
                                ‚Üê Kembali
                            </button>
                        </div>

                        <div style="background: ${surfaceColor}; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${textColor}; margin-bottom: 8px;">
                                        Pilih Kakitangan
                                    </label>
                                    <select 
                                        onchange="state.selectedStaffIc = this.value; render();"
                                        style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; box-sizing: border-box;"
                                    >
                                        ${staffList.map(s => `
                                            <option value="${s.ic}" ${s.ic === state.selectedStaffIc ? 'selected' : ''}>
                                                ${s.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${textColor}; margin-bottom: 8px;">
                                        Bulan
                                    </label>
                                    <select 
                                        onchange="state.selectedMonth = parseInt(this.value); render();"
                                        style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; box-sizing: border-box;"
                                    >
                                        ${MONTHS.map((m, i) => `
                                            <option value="${i}" ${i === state.selectedMonth ? 'selected' : ''}>
                                                ${m}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${textColor}; margin-bottom: 8px;">
                                        Tahun
                                    </label>
                                    <select 
                                        onchange="state.selectedYear = parseInt(this.value); render();"
                                        style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: ${baseSize * 0.9}px; color: ${textColor}; background: white; box-sizing: border-box;"
                                    >
                                        ${[2024, 2025, 2026, 2027].map(y => `
                                            <option value="${y}" ${y === state.selectedYear ? 'selected' : ''}>
                                                ${y}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        ${!selectedStaff ? `
                            <div style="background: ${surfaceColor}; border-radius: 12px; padding: 48px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <div style="font-size: ${baseSize * 1.2}px; color: ${secondaryColor};">
                                    Tiada kakitangan dijumpai. Sila daftar kakitangan terlebih dahulu.
                                </div>
                            </div>
                        ` : `
                            <div style="background: ${surfaceColor}; border-radius: 12px; padding: 32px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <div style="text-align: center; margin-bottom: 32px;">
                                    <div style="font-size: ${baseSize * 1.5}px; font-weight: 800; color: ${textColor}; margin-bottom: 8px;">
                                        LAPORAN KEHADIRAN BULANAN
                                    </div>
                                    <div style="font-size: ${baseSize}px; color: ${secondaryColor}; margin-bottom: 4px; text-transform: uppercase; font-weight: 700;">
                                        ${selectedStaff.name} (${selectedStaff.ic})
                                    </div>
                                    <div style="font-size: ${baseSize * 0.9}px; color: ${secondaryColor}; margin-bottom: 12px;">
                                        ${MONTHS[state.selectedMonth]} ${state.selectedYear}
                                    </div>
                                </div>

                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                                <th style="padding: 12px; text-align: center; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor}; width: 60px;">HARI</th>
                                                <th style="padding: 12px; text-align: left; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">TARIKH</th>
                                                <th style="padding: 12px; text-align: center; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">MASUK</th>
                                                <th style="padding: 12px; text-align: center; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">KELUAR</th>
                                                <th style="padding: 12px; text-align: center; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${secondaryColor};">STATUS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.keys(dailyRecords).map(day => {
                                                const record = dailyRecords[day];
                                                return `
                                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                                        <td style="padding: 10px; text-align: center; font-size: ${baseSize * 0.9}px; color: ${textColor}; font-weight: 600;">${day}</td>
                                                        <td style="padding: 10px; font-size: ${baseSize * 0.9}px; color: ${textColor};">${record.date}</td>
                                                        <td style="padding: 10px; text-align: center; font-size: ${baseSize * 0.9}px; color: ${textColor};">${record.clockIn}</td>
                                                        <td style="padding: 10px; text-align: center; font-size: ${baseSize * 0.9}px; color: ${textColor};">${record.clockOut}</td>
                                                        <td style="padding: 10px; text-align: center;">
                                                            <span style="display: inline-block; padding: 4px 10px; background: ${record.status === 'Hadir' ? '#dcfce7' : record.status === 'Masuk sahaja' ? '#fef3c7' : record.status === 'C' ? '#dbeafe' : record.status === 'Tidak Hadir' ? '#fecaca' : '#f3f4f6'}; color: ${record.status === 'Hadir' ? '#166534' : record.status === 'Masuk sahaja' ? '#92400e' : record.status === 'C' ? '#1e40af' : record.status === 'Tidak Hadir' ? '#7f1d1d' : '#6b7280'}; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-weight: 600;">
                                                                ${record.status}
                                                            </span>
                                                            ${record.note ? `<div style="font-size: ${baseSize * 0.65}px; color: ${secondaryColor}; margin-top: 4px; font-style: italic;">${record.note}</div>` : ''}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>

                                <div style="margin-top: 32px; text-align: center;">
                                    <button 
                                        onclick="printPDF()"
                                        style="padding: 14px 40px; background: ${primaryColor}; color: white; font-size: ${baseSize * 1.1}px; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);"
                                    >
                                        üìÑ CETAK / SIMPAN PDF
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        window.handleLogin = (e) => {
            e.preventDefault();
            const icInput = e.target.ic.value.trim();
            const icClean = icInput.replace(/[-\s]/g, '');
            
            const user = state.users.find(u => {
                const userIcClean = u.ic.replace(/[-\s]/g, '');
                return userIcClean === icClean;
            });
            
            if (user) {
                state.currentUser = user;
                state.view = user.role === 'pentadbir' ? 'admin' : 'dashboard';
                notify(`Selamat datang ${user.name}!`, 'success');
                render();
            } else {
                if (state.users.length === 0) {
                    notify('Tiada pengguna berdaftar. Sila daftar pengguna baru dahulu.', 'error');
                } else {
                    notify(`No. IC "${icInput}" tidak dijumpai dalam sistem. Sila daftar terlebih dahulu.`, 'error');
                }
            }
        };

        window.handleRegister = (e) => {
            e.preventDefault();
            const name = state.regName.trim();
            const ic = state.regIc.trim();
            const role = document.getElementById('reg-role').value;
            
            let shift = 'Tidak Berkenaan';
            if (role === 'guru') {
                shift = 'Isnin-Khamis: 7.40am-1.40pm, Jumaat: 7.40am-12.10pm';
            } else if (role === 'guru besar') {
                shift = '7.30 - 4.30';
            } else if (role === 'akp') {
                const shiftSelect = document.getElementById('reg-shift');
                if (!shiftSelect || !shiftSelect.value) {
                    notify('Sila pilih syif waktu kerja!', 'error');
                    return;
                }
                shift = shiftSelect.value;
            }
            
            if (name && ic && role) {
                registerUser(name, ic, role, shift);
            }
        };

        window.handleRoleChange = (role) => {
            state.regRole = role;
            render();
        };

        window.handleLogout = () => {
            state.currentUser = null;
            state.view = 'login';
            state.regRole = null;
            render();
        };

        window.showPunchModal = (action) => {
            state.punchModalAction = action;
            state.showPunchModal = true;
            render();
        };

        window.closePunchModal = () => {
            state.showPunchModal = false;
            state.punchModalAction = null;
            render();
        };

        window.submitPunchWithNote = async (e) => {
            e.preventDefault();
            
            let note = '';
            const categorySelect = document.getElementById('punch-category');
            
            if (categorySelect) {
                const category = categorySelect.value;
                const customNote = document.getElementById('punch-note')?.value.trim();
                
                if (category === 'LAIN - LAIN' || category === '4 HOUR TIME SLIP') {
                    note = customNote ? `${category}: ${customNote}` : category;
                } else {
                    note = category;
                }
            } else {
                note = document.getElementById('punch-note')?.value.trim() || '';
            }
            
            await recordAttendance(state.punchModalAction, note);
            closePunchModal();
        };

        window.handleCategoryChange = (value) => {
            const container = document.getElementById('custom-note-container');
            if (container) {
                if (value === 'LAIN - LAIN' || value === '4 HOUR TIME SLIP') {
                    container.style.display = 'block';
                    container.style.animation = 'fadeIn 0.3s ease-in';
                } else {
                    container.style.display = 'none';
                }
            }
        };

        window.showDeleteModal = (type, backendId) => {
            state.deleteModal = { type, backendId };
            render();
        };

        window.closeDeleteModal = () => {
            state.deleteModal = null;
            render();
        };

        window.confirmDelete = async () => {
            if (!state.deleteModal) return;
            
            const { type, backendId } = state.deleteModal;
            
            if (type === 'user') {
                const user = state.users.find(u => u.__backendId === backendId);
                if (user) await deleteUser(user);
            } else if (type === 'attendance') {
                const record = state.attendance.find(r => r.__backendId === backendId);
                if (record) await deleteAttendance(record);
            }
            
            closeDeleteModal();
        };

        window.changeUserCardColor = async (userIc, color) => {
            if (!window.elementSdk) return;
            
            const config = window.elementSdk.config || defaultConfig;
            const updatedColors = { ...(config.user_card_colors || {}), [userIc]: color };
            
            await window.elementSdk.setConfig({ user_card_colors: updatedColors });
            notify(`Warna kad dikemaskini kepada ${color === 'green' ? 'hijau' : color === 'yellow' ? 'kuning' : 'merah'}!`, 'success');
        };

        window.showEditUserModal = (backendId) => {
            state.editUserModal = backendId;
            render();
        };

        window.closeEditUserModal = () => {
            state.editUserModal = null;
            render();
        };

        window.submitEditUser = async (e) => {
            e.preventDefault();
            
            const user = state.users.find(u => u.__backendId === state.editUserModal);
            if (!user) return;
            
            const newName = document.getElementById('edit-name').value.trim();
            const newIc = document.getElementById('edit-ic').value.trim();
            
            if (newName && newIc) {
                await updateUser(user, newName, newIc);
                closeEditUserModal();
            }
        };

        window.changeCardColor = async (backendId, color) => {
            const user = state.users.find(u => u.__backendId === backendId);
            if (user) {
                await updateUserCardColor(user, color);
            }
        };

        window.addAdminNote = (userIc, dateStr) => {
            const user = state.users.find(u => u.ic === userIc);
            if (!user) return;
            
            state.selectedNoteStatus = 'hadir';
            state.showNoteModal = {
                type: 'add',
                userIc: userIc,
                userName: user.name,
                dateStr: dateStr,
                currentNote: ''
            };
            render();
        };

        window.selectNoteStatus = (status) => {
            state.selectedNoteStatus = status;
            
            const hadirBtn = document.getElementById('status-hadir');
            const tidakHadirBtn = document.getElementById('status-tidak-hadir');
            
            if (hadirBtn && tidakHadirBtn) {
                if (status === 'hadir') {
                    hadirBtn.style.border = '3px solid #16a34a';
                    hadirBtn.style.boxShadow = '0 0 0 3px rgba(22, 163, 74, 0.2)';
                    tidakHadirBtn.style.border = '3px solid #fecaca';
                    tidakHadirBtn.style.boxShadow = 'none';
                } else {
                    tidakHadirBtn.style.border = '3px solid #dc2626';
                    tidakHadirBtn.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.2)';
                    hadirBtn.style.border = '3px solid #dcfce7';
                    hadirBtn.style.boxShadow = 'none';
                }
            }
        };

        window.editDailyRecord = (userIc, dateStr) => {
            const user = state.users.find(u => u.ic === userIc);
            if (!user) return;
            
            const dayRecords = state.attendance.filter(a => a.ic === userIc && a.date === dateStr);
            const clockIn = dayRecords.find(r => r.action === 'masuk');
            const clockOut = dayRecords.find(r => r.action === 'keluar');
            const thRecord = dayRecords.find(r => r.action === 'th');
            const bersebabRecord = dayRecords.find(r => r.action === 'bersebab');
            
            let currentStatus = '';
            let currentNote = '';
            let recordToEdit = null;
            
            if (thRecord) {
                currentStatus = 'TIDAK HADIR';
                currentNote = thRecord.note || '';
                recordToEdit = thRecord;
            } else if (bersebabRecord) {
                currentStatus = 'BERSEBAB';
                currentNote = bersebabRecord.note || '';
                recordToEdit = bersebabRecord;
            } else if (clockIn) {
                currentStatus = 'HADIR';
                currentNote = clockIn.note || clockOut?.note || '';
                recordToEdit = clockIn;
            }
            
            if (!recordToEdit) return;
            
            state.showNoteModal = {
                type: 'edit',
                userIc: userIc,
                userName: user.name,
                dateStr: dateStr,
                currentNote: currentNote,
                currentStatus: currentStatus,
                recordToEdit: recordToEdit
            };
            render();
        };

        window.closeNoteModal = () => {
            state.showNoteModal = null;
            render();
        };

        window.submitNoteModal = async (e) => {
            e.preventDefault();
            
            const noteInput = document.getElementById('note-input').value.trim();
            
            if (!state.showNoteModal) return;
            
            state.loading = true;
            render();
            
            if (state.showNoteModal.type === 'add') {
                const user = state.users.find(u => u.ic === state.showNoteModal.userIc);
                const now = new Date();
                
                // Gunakan status yang dipilih oleh admin
                const actionType = state.selectedNoteStatus === 'hadir' ? 'bersebab' : 'th';
                
                const result = await window.dataSdk.create({
                    type: 'attendance',
                    name: user.name,
                    ic: user.ic,
                    role: user.role,
                    shift: user.shift,
                    date: state.showNoteModal.dateStr,
                    time: now.toTimeString().split(' ')[0].substring(0, 5),
                    action: actionType,
                    note: noteInput ? `[Admin] ${noteInput}` : '[Admin]',
                    timestamp: Date.now()
                });
                
                state.loading = false;
                
                if (result.isOk) {
                    notify('Catatan berjaya ditambah!', 'success');
                    state.showNoteModal = null;
                    render();
                } else {
                    notify('Ralat menambah catatan!', 'error');
                    render();
                }
            } else if (state.showNoteModal.type === 'edit') {
                const recordToEdit = state.showNoteModal.recordToEdit;
                recordToEdit.note = noteInput;
                
                const result = await window.dataSdk.update(recordToEdit);
                
                state.loading = false;
                
                if (result.isOk) {
                    notify('Catatan berjaya dikemaskini!', 'success');
                    state.showNoteModal = null;
                    render();
                } else {
                    notify('Ralat mengemaskini catatan!', 'error');
                    render();
                }
            }
        };

        async function onConfigChange(config) {
            render();
        }

        async function init() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.background_color || defaultConfig.background_color,
                                set: (value) => {
                                    config.background_color = value;
                                    window.elementSdk.setConfig({ background_color: value });
                                }
                            },
                            {
                                get: () => config.surface_color || defaultConfig.surface_color,
                                set: (value) => {
                                    config.surface_color = value;
                                    window.elementSdk.setConfig({ surface_color: value });
                                }
                            },
                            {
                                get: () => config.text_color || defaultConfig.text_color,
                                set: (value) => {
                                    config.text_color = value;
                                    window.elementSdk.setConfig({ text_color: value });
                                }
                            },
                            {
                                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                                set: (value) => {
                                    config.primary_action_color = value;
                                    window.elementSdk.setConfig({ primary_action_color: value });
                                }
                            },
                            {
                                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                                set: (value) => {
                                    config.secondary_action_color = value;
                                    window.elementSdk.setConfig({ secondary_action_color: value });
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: {
                            get: () => config.font_family || defaultConfig.font_family,
                            set: (value) => {
                                config.font_family = value;
                                window.elementSdk.setConfig({ font_family: value });
                            }
                        },
                        fontSizeable: {
                            get: () => config.font_size || defaultConfig.font_size,
                            set: (value) => {
                                config.font_size = value;
                                window.elementSdk.setConfig({ font_size: value });
                            }
                        }
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["app_title", config.app_title || defaultConfig.app_title],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                        ["login_button_text", config.login_button_text || defaultConfig.login_button_text],
                        ["register_button_text", config.register_button_text || defaultConfig.register_button_text],
                        ["clock_in_text", config.clock_in_text || defaultConfig.clock_in_text],
                        ["clock_out_text", config.clock_out_text || defaultConfig.clock_out_text]
                    ])
                });
            }

            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    notify("Ralat memulakan sistem!", "error");
                }
            }
            
            state.initialized = true;
            render();
        }

        init();
    </script>
</body>
</html>